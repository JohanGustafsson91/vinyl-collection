import { useCallback, useEffect, useState } from "react";
import { getAlbumsFromDatabase } from "api/albums";
import { InferGetStaticPropsType } from "next";
import Head from "next/head";
import styled from "styled-components";
import { breakpoint, breakpointSize, fontSize, space } from "theme";

import { Album } from "components/Album";
import { Filter, FilterOptions } from "components/Filter";

export default function Home({
  albums,
}: InferGetStaticPropsType<typeof getStaticProps>) {
  const [filteredAlbums, setFilteredAlbums] = useState(albums);

  useEffect(
    function updateFilteredAlbums() {
      albums.length && setFilteredAlbums(albums);
    },
    [albums]
  );

  const handleFilterAlbums = useCallback(
    ({ query, includeTrack }: FilterOptions) => {
      if (query === "") {
        return setFilteredAlbums(albums);
      }

      const albumsFiltered = albums.filter(function filterAlbum(album) {
        const matchArtist = album.artist
          .toLowerCase()
          .includes(query.toLowerCase());

        const matchTitle = album.title
          .toLowerCase()
          .includes(query.toLowerCase());

        const matchTrack = includeTrack
          ? album.tracks.some(function textIncludesString(track) {
              return track.title.toLowerCase().includes(query.toLowerCase());
            })
          : false;

        return [matchArtist, matchTitle, matchTrack].some(Boolean);
      });

      setFilteredAlbums(albumsFiltered);
    },
    [albums]
  );

  return (
    <Page>
      <Head>
        <title>Vinyl Collection</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>

      <Menu>
        <MenuContent>
          <Logo>Vinyl Collection</Logo>
          <Filter onFilter={handleFilterAlbums} />
        </MenuContent>
      </Menu>

      <Content>
        <Container>
          {filteredAlbums.map((album, i) => (
            <div key={album.id} style={{ placeSelf: "center" }}>
              <Album album={album} />
              {i % 2 === 0 ? <Shelf /> : null}
            </div>
          ))}
        </Container>
      </Content>
    </Page>
  );
}

export async function getStaticProps() {
  const albums = await getAlbumsFromDatabase().catch(() => undefined);

  return albums
    ? {
        props: {
          albums,
        },
      }
    : {
        notFound: true,
      };
}

const Page = styled.div`
  background-color: var(--color-content);

  ${breakpoint("max-width")} {
    background-color: var(--color-background);
    padding: ${space(5)} 0 0 0;
  }
`;

const Menu = styled.div`
  width: 100%;
  position: sticky;
  top: 0;
  z-index: var(--zIndex-menu);
  background-color: var(--color-background);
`;

const MenuContent = styled.div`
  width: 100%;
  max-width: ${breakpointSize("max-width")};
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  margin: 0 auto;
  padding: ${space(3)} ${space(3)};
  background-color: var(--color-content);

  ${breakpoint(0)} {
    flex-direction: row;
    padding: ${space(4)} ${space(5)};
    align-items: center;
  }

  ${breakpoint("max-width")} {
    border-top-left-radius: ${space(4)};
    border-top-right-radius: ${space(4)};
  }
`;

const Logo = styled.span`
  font-weight: 700;
  font-size: ${fontSize(3)};
  text-transform: uppercase;
  margin-bottom: ${space(3)};

  ${breakpoint(0)} {
    margin-bottom: 0;
  }
`;

const Content = styled.div`
  position: relative;
  overflow: hidden;
  height: 100%;
  width: 100%;
`;

const Container = styled.div`
  position: relative;
  width: 100%;
  max-width: ${breakpointSize("max-width")};
  background-color: var(--color-content);
  display: grid;
  grid-template-columns: 1fr 1fr;
  row-gap: ${space(5)};
  right: -${fontSize(6)};
  padding: ${space(3)} ${fontSize(6)} ${space(5)} 0;

  ${breakpoint("max-width")} {
    margin: 0 auto;
    padding-top: ${space(5)};
    grid-template-columns: 1fr 1fr 1fr 1fr;
    right: 0;
    padding: ${space(5)} ${space(4)} ${space(6)} ${space(4)};
  }
`;

const Shelf = styled.div`
  position: absolute;
  top: inherit;
  border-bottom: ${fontSize(4)} solid #eae1d4;
  border-left: ${space(4)} solid transparent;
  border-right: ${space(4)} solid transparent;
  margin-top: -${space(2)};
  left: -${space(4)};
  width: calc(100% + ${space(5)});
  z-index: var(--zIndex-shelf);

  &:after {
    content: "";
    background: var(--color-shelf-border);
    height: ${space(2)};
    width: calc(100% + ${space(5)});
    position: absolute;
    top: ${fontSize(4)};
    left: -${space(4)};
    right: 0;
    z-index: var(--zIndex-shelf-border);
    margin: 0;
    box-shadow: rgba(0, 0, 0, 0.7) 0px 10px 30px;

    ${breakpoint(0)} {
      height: ${fontSize(0)};
    }
  }
`;
